name: UgsSyncSmf
script:
  embeddedFiles:
  - name: UgsSync
    filename: UgsSync.bat
    type: TEXT
    data: |
      :: Get or Create P4 workspace with UGS
      :: ugs switch {{Param.PerforceStreamPath}}
      set "WorkspaceName=%USERNAME%_%COMPUTERNAME%_{{Param.ProjectName}}"
      if defined DEADLINE_WORKER_ID (
          set "WorkspaceName=%WorkspaceName%_%DEADLINE_WORKER_ID%"
      )
      ugs init {{Param.PerforceStreamPath}} -client=%WorkspaceName% -project={{Param.ProjectRelativePath}}
      
      :: Find workspace root folder named as Stream path with "/" replaced by "+" (UGS CLI does it by default)
      set "WorkspaceFolderName={{Param.PerforceStreamPath}}"
      set "WorkspaceFolderName=%WorkspaceFolderName:/=+%"
      
      :: Go to this directory
      cd /d %WorkspaceFolderName%

      :: Sync to given changelist, no generate proj files, overwrite clobber files, sync binaries
      ugs sync {{Param.PerforceChangelistNumber}} -nogpf -clobber -binaries
      echo Sync completed successfuly
      
      :: Store this path to Env variable for future using while launching the Unreal Editor and Project within
      echo openjd_env: P4_CLIENT_DIRECTORY=%CD%
      :: Store WorkspaceName env variable to use it in RemovePerforceWorkspace
      echo openjd_env: WorkspaceName=%WorkspaceName%
      
      :: Error handling
      IF ERRORLEVEL NEQ 0 (
          echo Error detected! Code: %ERRORLEVEL%
      	  exit /b !ERRORCODE!
      ) ELSE (
          echo Command succeeded!
      )
  - name: RemovePerforceWorkspace
    filename: RemovePerforceWorkspace.bat
    type: TEXT
    data: |
      :: Clear workspace files
      p4 sync -f %P4_CLIENT_DIRECTORY%/...#0
      
      :: Delete workspace
      p4 client -d -f %WorkspaceName%
      
      :: Remove env variable
      echo openjd_unset_env: P4_CLIENT_DIRECTORY
  actions:
    onEnter:
      command: '{{Env.File.UgsSync}}'
      cancelation:
        mode: NOTIFY_THEN_TERMINATE
    onExit:
      command: '{{Env.File.RemovePerforceWorkspace}}'
      cancelation:
        mode: NOTIFY_THEN_TERMINATE