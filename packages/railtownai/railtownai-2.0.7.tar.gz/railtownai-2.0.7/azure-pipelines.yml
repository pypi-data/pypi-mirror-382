trigger:
  - main

pr:
  - "*" # All PRs regardless of target branch

jobs:
  - job: build
    displayName: "üõ†Ô∏è Build and Test"
    pool:
      vmImage: "ubuntu-latest"
    steps:
      - checkout: self

      - task: UsePythonVersion@0
        displayName: "Setup Python 3.10"
        inputs:
          versionSpec: "3.10"
          addToPath: true

      - script: |
          python -m pip install --upgrade pip
          pip install -e ".[test]"
        displayName: "Install dependencies"

      - script: |
          python scripts/check_licenses.py
        displayName: "Check licenses"

      - script: |
          ruff check .
        displayName: "Lint with Ruff"

      - script: |
          pytest -s -v --junit-xml=test-results.xml
        displayName: "Run tests"
        continueOnError: true
        env:
          RAILTOWN_API_KEY: $(RAILTOWN_API_KEY)

      - task: PublishTestResults@2
        displayName: "Surface failing tests"
        inputs:
          testResultsFiles: "test-results.xml"
          testRunTitle: "Test results"
          failTaskOnFailedTests: true
