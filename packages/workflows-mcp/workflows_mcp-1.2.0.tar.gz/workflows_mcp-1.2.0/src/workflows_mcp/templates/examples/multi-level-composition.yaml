name: multi-level-composition
description: Demonstrates 3-level workflow composition with variable passing and output propagation
version: "1.0"
author: Workflows MCP Team
tags: [test, examples, composition, multi-level, advanced, tutorial]
inputs:
  project_name:
    type: string
    description: Project name for demonstration
    default: "demo-project"

  base_path:
    type: string
    description: Base working directory
    default: "/tmp/workflow-demo"

  run_full_pipeline:
    type: boolean
    description: Run complete pipeline or just setup
    default: true

blocks:
  # Level 1: Initialize project structure
  - id: init_message
    type: EchoBlock
    inputs:
      message: "Starting multi-level composition demo for ${project_name}"

  # Level 2: Create feature branch (calls Git workflow)
  - id: create_branch
    type: ExecuteWorkflow
    inputs:
      workflow: "create-feature-branch"
      inputs:
        branch_name: "feature/${project_name}-demo"
        base_branch: "main"
        working_dir: "."
        fetch_first: false
        push_to_remote: false
    depends_on:
      - init_message

  # Level 2: Generate project README (calls File workflow)
  - id: generate_readme
    type: ExecuteWorkflow
    inputs:
      workflow: "generate-readme"
      inputs:
        project_name: "${project_name}"
        description: "Multi-level composition demonstration project"
        author: "Workflows MCP"
        version: "1.0.0"
        template_path: "${base_path}/README.template.md"
        output_path: "${base_path}/README.md"
        create_template_if_missing: true
    depends_on:
      - init_message

  # Get composition statuses
  - id: get_branch_status
    type: BashCommand
    inputs:
      command: "test '${create_branch.success}' = 'true' && echo 'Created' || echo 'Failed'"
      timeout: 5
      check_returncode: false
    depends_on:
      - create_branch

  - id: get_readme_status
    type: BashCommand
    inputs:
      command: "test '${generate_readme.success}' = 'true' && echo 'Generated' || echo 'Failed'"
      timeout: 5
      check_returncode: false
    depends_on:
      - generate_readme

  # Level 2: Show composition results
  - id: composition_status
    type: EchoBlock
    inputs:
      message: |
        Level 2 Composition Results:
        - Branch: ${create_branch.branch_name} (${get_branch_status.stdout})
        - README: ${generate_readme.readme_path} (${get_readme_status.stdout})
    depends_on:
      - get_branch_status
      - get_readme_status

  # Level 3: Run CI pipeline (calls CI workflow which calls Python workflows)
  - id: run_ci_pipeline
    type: ExecuteWorkflow
    inputs:
      workflow: "python-ci-pipeline"
      inputs:
        project_path: "."
        python_version: "3.12"
        skip_setup: true
        coverage_threshold: 75
        strict_linting: false
    depends_on:
      - composition_status
    condition: "${run_full_pipeline} and ${create_branch.success}"

  # Level 3: Conditional deployment
  - id: deploy_if_tests_pass
    type: ExecuteWorkflow
    inputs:
      workflow: "conditional-deploy"
      inputs:
        environment: "dev"
        deploy_path: "${base_path}/deploy"
        run_tests_first: false
        build_artifacts: false
    depends_on:
      - run_ci_pipeline
    condition: "${run_full_pipeline} and ${run_ci_pipeline.success}"

  # Get final summary displays
  - id: get_git_branch_display
    type: BashCommand
    inputs:
      command: "test '${create_branch.success}' = 'true' && echo '✓ ${create_branch.branch_name}' || echo '✗ Failed'"
      timeout: 5
      check_returncode: false
    depends_on:
      - create_branch

  - id: get_readme_display
    type: BashCommand
    inputs:
      command: "test '${generate_readme.success}' = 'true' && echo '✓ Generated' || echo '✗ Failed'"
      timeout: 5
      check_returncode: false
    depends_on:
      - generate_readme

  - id: get_ci_pipeline_display_passed
    type: BashCommand
    inputs:
      command: "echo '✓ Passed'"
      timeout: 5
      check_returncode: false
    condition: "${run_full_pipeline} and ${run_ci_pipeline.success}"
    depends_on:
      - run_ci_pipeline

  - id: get_ci_pipeline_display_failed
    type: BashCommand
    inputs:
      command: "echo '✗ Failed'"
      timeout: 5
      check_returncode: false
    condition: "${run_full_pipeline} and not ${run_ci_pipeline.success}"
    depends_on:
      - run_ci_pipeline

  - id: get_ci_pipeline_display_skipped
    type: BashCommand
    inputs:
      command: "echo '⊘ Skipped'"
      timeout: 5
      check_returncode: false
    condition: "not ${run_full_pipeline}"
    depends_on:
      - run_ci_pipeline

  - id: get_ci_pipeline_display
    type: BashCommand
    inputs:
      command: |
        STATUS_PASSED="${get_ci_pipeline_display_passed.stdout}"
        STATUS_FAILED="${get_ci_pipeline_display_failed.stdout}"
        STATUS_SKIPPED="${get_ci_pipeline_display_skipped.stdout}"
        if [ -n "$STATUS_PASSED" ]; then
          echo "$STATUS_PASSED"
        elif [ -n "$STATUS_FAILED" ]; then
          echo "$STATUS_FAILED"
        else
          echo "$STATUS_SKIPPED"
        fi
      timeout: 5
      check_returncode: false
    depends_on:
      - get_ci_pipeline_display_passed
      - get_ci_pipeline_display_failed
      - get_ci_pipeline_display_skipped

  - id: get_deployment_display
    type: BashCommand
    inputs:
      command: |
        if [ "${run_full_pipeline}" = "true" ]; then
          if [ "${deploy_if_tests_pass.deployed}" = "true" ]; then
            echo "✓ Deployed to ${deploy_if_tests_pass.environment}"
          else
            echo '✗ Failed'
          fi
        else
          echo '⊘ Skipped'
        fi
      timeout: 5
      check_returncode: false
    depends_on:
      - deploy_if_tests_pass

  - id: get_workflows_count
    type: BashCommand
    inputs:
      command: "test '${run_full_pipeline}' = 'true' && echo '5' || echo '3'"
      timeout: 5
      check_returncode: false
    depends_on:
      - deploy_if_tests_pass

  - id: get_overall_status_success
    type: BashCommand
    inputs:
      command: "echo '✓ SUCCESS'"
      timeout: 5
      check_returncode: false
    condition: "${create_branch.success} and ${generate_readme.success} and (not ${run_full_pipeline} or (${run_ci_pipeline.success} and ${deploy_if_tests_pass.deployed}))"
    depends_on:
      - get_ci_pipeline_display
      - get_deployment_display

  - id: get_overall_status_partial
    type: BashCommand
    inputs:
      command: "echo '✗ PARTIAL SUCCESS'"
      timeout: 5
      check_returncode: false
    condition: "not (${create_branch.success} and ${generate_readme.success} and (not ${run_full_pipeline} or (${run_ci_pipeline.success} and ${deploy_if_tests_pass.deployed})))"
    depends_on:
      - get_ci_pipeline_display
      - get_deployment_display

  - id: get_overall_status
    type: BashCommand
    inputs:
      command: |
        STATUS_SUCCESS="${get_overall_status_success.stdout}"
        STATUS_PARTIAL="${get_overall_status_partial.stdout}"
        if [ -n "$STATUS_SUCCESS" ]; then
          echo "$STATUS_SUCCESS"
        else
          echo "$STATUS_PARTIAL"
        fi
      timeout: 5
      check_returncode: false
    depends_on:
      - get_overall_status_success
      - get_overall_status_partial

  # Final summary across all composition levels
  - id: final_summary
    type: EchoBlock
    inputs:
      message: |
        ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        Multi-Level Composition Demo Complete
        ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        Project: ${project_name}
        ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        Level 1 (Direct Blocks):
          - Initialization: ✓ Complete

        Level 2 (Workflow Composition):
          - Git Branch: ${get_git_branch_display.stdout}
          - README: ${get_readme_display.stdout}

        Level 3 (Nested Composition):
          - CI Pipeline: ${get_ci_pipeline_display.stdout}
          - Deployment: ${get_deployment_display.stdout}
        ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
        Composition Depth: 3 levels
        Workflows Executed: ${get_workflows_count.stdout} workflows
        Overall Status: ${get_overall_status.stdout}
        ━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
    depends_on:
      - get_git_branch_display
      - get_readme_display
      - get_ci_pipeline_display
      - get_deployment_display
      - get_workflows_count
      - get_overall_status

outputs:
  success: "${create_branch.success} and ${generate_readme.success}"
  project_name: "${project_name}"

  # Level 2 outputs
  branch_created: "${create_branch.success}"
  branch_name: "${create_branch.branch_name}"
  readme_generated: "${generate_readme.success}"
  readme_path: "${generate_readme.readme_path}"

  # Level 3 outputs (if executed)
  pipeline_executed: "${run_full_pipeline}"
  pipeline_passed: "${run_ci_pipeline.success}"
  deployed: "${deploy_if_tests_pass.deployed}"
  deployment_env: "${deploy_if_tests_pass.environment}"

  # Summary
  summary: "${final_summary.echoed}"
  composition_levels: "3"
  workflows_executed: "${get_workflows_count.stdout}"
