name: run-npm-test
description: Execute npm test with coverage reporting
version: "1.0"
author: "mcp-workflows"
tags: [node, "node", "npm", "testing", "jest", "coverage"]
inputs:
  working_dir:
    type: string
    description: "Project directory containing package.json"
    default: "."

  test_script:
    type: string
    description: "npm script to run (from package.json)"
    default: "test"

  with_coverage:
    type: boolean
    description: "Run tests with coverage"
    default: true

blocks:
  - id: check_package_json
    type: BashCommand
    inputs:
      command: "test -f package.json && echo 'package.json found'"
      working_dir: "${working_dir}"
      timeout: 10

  - id: build_test_command
    type: BashCommand
    inputs:
      command: |
        CMD="npm run ${test_script}"
        if [ "${with_coverage}" = "true" ]; then
          CMD="$CMD -- --coverage"
        fi
        echo "$CMD"
      timeout: 5
    depends_on:
      - check_package_json

  - id: run_npm_test
    type: BashCommand
    inputs:
      command: "${build_test_command.stdout}"
      working_dir: "${working_dir}"
      timeout: 600
      env:
        CI: "true"
        NODE_ENV: "test"
    depends_on:
      - build_test_command

outputs:
  success: "${run_npm_test.success}"
  exit_code: "${run_npm_test.exit_code}"
  test_output: "${run_npm_test.stdout}"
  errors: "${run_npm_test.stderr}"
  execution_time_ms: "${run_npm_test.execution_time_ms}"
