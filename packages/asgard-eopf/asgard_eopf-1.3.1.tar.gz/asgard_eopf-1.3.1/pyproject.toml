# Copyright 2022-2025 CS GROUP
#
# Licensed to CS GROUP (CS) under one or more
# contributor license agreements.  See the NOTICE file distributed with
# this work for additional information regarding copyright ownership.
# CS licenses this file to You under the Apache License, Version 2.0
# (the "License"); you may not use this file except in compliance with
# the License.  You may obtain a copy of the License at
#
#   http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.


# `pyproject.toml` is a configuration file used by packaging tools,
# as well as other tools such as linters, type checkers, etc.
# Tells pip that Cython is required for setup.py to execute.
# https://peps.python.org/pep-0518/
# https://packaging.python.org/en/latest/guides/writing-pyproject-toml/

[build-system]
requires = ["setuptools", "setuptools-scm>=8", "wheel", "cython>=0.29"]
build-backend = "setuptools.build_meta"

[project]
name = "asgard_eopf"
description = "A Sensor Geometry Application Re-usable by-Design"
readme = "README.md"
keywords = ["asgard", "rugged", "orekit", "hipparchus", "eopf"]
authors = [
  {name = "CS Group", email = "pyrugged@csgroup.eu"},
]
license-files = [
    'LICENSE',  # Apache-2.0
]
classifiers = [
    'Development Status :: 5 - Production/Stable',
    'Programming Language :: Python',
    'Programming Language :: Python :: 3',
    'Programming Language :: Python :: 3.11',
    'Programming Language :: Python :: 3.12',
    'Programming Language :: Python :: 3.13',
    'Programming Language :: Python :: 3.14',
    'Programming Language :: Python :: 3 :: Only',
    'Programming Language :: Python :: Implementation :: CPython',
    'Operating System :: POSIX',
    'Operating System :: Unix',
]

requires-python = ">= 3.8"

dynamic = ["version"]
# -> tells pip to use setuptools-scm to determine version
# https://setuptools-scm.readthedocs.io/en/v8.2.1/usage/

# Most pinned version are defined to match EOPF CPM v2.5.9:
# https://gitlab.eopf.copernicus.eu/cpm/eopf-cpm/-/blob/2.5.9/pyproject.toml#L22-71
dependencies = [
  "orekit-jcc >=13.2,<13.3",
  "pyrugged >=1.1.3,<1.2",
  "forbiddenfruit",         # asgard/wrappers/orekit/jcc_util.py needs curse
  "scikit-learn >= 1.3.0",  # asgard/core/math.pyx needs sklearn at runtime, cf. !280
  "s3fs == 2024.5.0",       # zarr fsspec needs s3fs to access S3, -> eopf-cpm/-/blob/2.5.9/pyproject.toml#L53
  "numcodecs == 0.15.1",    # must match: https://gitlab.eopf.copernicus.eu/cpm/eopf-cpm/-/blob/2.5.9/pyproject.toml#L30
  "zarr == 2.18.4",         # must match: https://gitlab.eopf.copernicus.eu/cpm/eopf-cpm/-/blob/2.5.9/pyproject.toml#L40
  "numpy >= 2.1.0",         # must match: https://gitlab.eopf.copernicus.eu/cpm/eopf-cpm/-/blob/2.5.9/pyproject.toml#L42
  "xarray == 2025.9.0",     # must match: CPM 2.6.2
  "jsonschema == 4.23.0",   # asgard/core/schema.py needs validators.extend, -> eopf-cpm/-/blob/2.5.9/pyproject.toml#L68
]

# NOTE on botocore conflicts:
# s3transfer (from boto3) 0.11.5 requires botocore<2.0a.0,>=1.37.4
# aiobotocore (from s3fs) 2.22.0 requires botocore<1.37.4,>=1.37.2
# Fixed thanks to: "aiobotocore[boto3]" since v0.4.4 (2017-08-17 commit ee09408)
# https://github.com/aio-libs/aiobotocore/issues/840#issuecomment-777763594
# https://github.com/aio-libs/aiobotocore/commit/ee094082267b0d861637479fe64a2efb810abd4a

[dependency-groups]
test = [
  "asgard-legacy-drivers",  # WARN: cross dep issue ?
  "aiobotocore[boto3]",  # fix boto3 conflict with s3fs
  "dask[array,distributed] == 2024.5.2",  # https://gitlab.eopf.copernicus.eu/cpm/eopf-cpm/-/blob/2.5.9/pyproject.toml#L36-37
  "dill",
  "lxml",
  "netcdf4",
  "pytest-allclose",
  "pytest",
  "shapely",
]
qa = [
  "bandit",
  "black>=21.5b0",
  "flake8-bugbear>=21.4.3",
  "flake8-comprehensions>=3.4.0",
  "flake8-copyright>=0.2.2",
  "flake8>=3.9.1",
  "isort>=5.8.0",
  "pylint>=2.13.6",
  "pytest-cov",
]
doc = [
  "mdutils",
  "myst_parser",
  "python-gitlab",
  "sphinx-rtd-theme",
  "sphinx",
  "tomark",
]
dev = [
  "pre-commit",
  "validate-pyproject",
  "cython >=0.29",  # for pylint setup.py in pre-commit
  {include-group = "test"},
  {include-group = "qa"},
  {include-group = "doc"},
  {include-group = "typing"},
]
notebook = [
  "folium",
  "jupyter",
  "matplotlib",
]
typing = [
    "mypy",
    "types-jsonschema",
    "types-setuptools",
    "types-toml",
    "lxml-stubs",
    "scipy-stubs",
]

[tool.setuptools]
package-dir = {"asgard" = "asgard"}
include-package-data = false  # pyproject defaults to true, including everything
package-data = {"*" = ["*.pyi"]}
# https://setuptools.pypa.io/en/latest/userguide/datafiles.html

[tool.setuptools_scm]
# can be empty if no extra settings are needed, presence enables setuptools-scm

[project.urls]
Homepage = "https://gitlab.eopf.copernicus.eu/geolib/asgard"
Documentation = "https://geolib.pages.eopf.copernicus.eu/asgard/"
Repository = "https://gitlab.eopf.copernicus.eu/geolib/asgard.git"
Issues = "https://gitlab.eopf.copernicus.eu/geolib/asgard/-/issues"
Changelog = "https://gitlab.eopf.copernicus.eu/geolib/asgard/-/blob/main/CHANGELOG.md"

[tool.bandit]
exclude_dirs = [".venv", "tests"]

[tool.black]
line-length = 120
target-version = ["py311"]

[tool.mypy]
python_version = "3.11"
warn_return_any = true
warn_unused_configs = true
warn_redundant_casts = true

[[tool.mypy.overrides]]
module = [
    "lxml",
    "boto3"
]
ignore_missing_imports = true

[tool.isort]
profile = "black"

[tool.pytest.ini_options]
log_format = "%(asctime)s.%(msecs)03d %(levelname)s %(filename)s:%(lineno)d %(message)s"
log_cli = true
log_cli_level = "INFO"
log_file_level = "INFO"

markers = [
  "dem",
  "slow",
  "pickle",
  "dask",
  "dask_map_block",
  "dask_eopf",
  "init_schema_example",
  "perfo",
]
testpaths = ["tests"]
norecursedirs = ["tests/helpers"]

# Ignore DeprecationWarnings from JCC (Orekit)
# https://issues.apache.org/jira/browse/PYLUCENE-51
# https://issues.apache.org/jira/browse/PYLUCENE-59
# https://docs.pytest.org/en/stable/how-to/capture-warnings.html
# https://docs.python.org/3/library/warnings.html#warning-filter
filterwarnings = [
    "ignore::DeprecationWarning:importlib._bootstrap",
]
