name: validate-code
env:
  PYTHON_VERSION: 3.9
  NAME_ENVIRONMENT_ARTIFACT: environment-artifact
  KPLER_BOT_PAT: ${{ secrets.KPLER_BOT_PAT }}
  PACKAGECLOUD_TOKEN: ${{ secrets.PACKAGECLOUD_TOKEN }}

on:
  workflow_call:

jobs:

  validate-code:
    name: Validate Code
    runs-on: ubuntu-22.04
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ env.KPLER_BOT_PAT }}
      - name: Setup Environment (install and export)
        uses: Kpler/github-actions/actions/python/install-and-export-environment@v2.275.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          name-environment-artifact: ${{ env.NAME_ENVIRONMENT_ARTIFACT }}
          packagecloud-read-token: ${{ env.PACKAGECLOUD_TOKEN }}
      - name: Setup Environment (get or create)
        uses: Kpler/github-actions/actions/python/get-or-create-environment@v2.275.0
        with:
          python-version: ${{ env.PYTHON_VERSION }}
          name-environment-artifact: ${{ env.NAME_ENVIRONMENT_ARTIFACT }}
      - name: Restore Cache
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: v1-pre-commit-py38-${{ hashFiles('.pre-commit-config.yaml') }}
      - name: Install Pre-commit
        uses: pre-commit/action@v3.0.1
        with:
          extra_args: --show-diff-on-failure --color=always --all-files --hook-stage push
          token: ${{ env.KPLER_BOT_PAT }}
      - name: Save Cache
        uses: actions/cache@v4
        with:
          key: v1-pre-commit-py38-${{ hashFiles('.pre-commit-config.yaml') }}
          path: ~/.cache/pre-commit
