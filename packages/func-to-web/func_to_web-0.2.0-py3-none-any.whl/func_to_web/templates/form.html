<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ title }}</title>
    <link rel="stylesheet" href="/static/styles.css">
</head>
<body class="form-page"> <div class="container"> <div class="form-page"> 
            <h1>{{ title }}</h1>
            <form id="form" novalidate>
                {% for field in fields %}
                    {% if field.type == 'checkbox' %}
                        <div class="field checkbox-field">
                            <input type="checkbox" 
                                   name="{{ field.name }}" 
                                   id="{{ field.name }}"
                                   {% if field.default %}checked{% endif %}>
                            <label for="{{ field.name }}">{{ field.name }}</label>
                        </div>
                    {% elif field.type == 'select' %}
                        <div class="field">
                            <label for="{{ field.name }}">{{ field.name }}</label>
                            <select name="{{ field.name }}" id="{{ field.name }}" {% if field.required %}required{% endif %}>
                                {% for option in field.options %}
                                    <option value="{{ option }}" 
                                            {% if field.default == option %}selected{% endif %}>
                                        {{ option }}
                                    </option>
                                {% endfor %}
                            </select>
                            <div class="field-error" id="error-{{ field.name }}"></div>
                        </div>
                    {% elif field.type == 'color' %}
                        <div class="field">
                            <label for="{{ field.name }}">{{ field.name }}</label>
                            <div class="color-input-wrapper">
                                <input type="text" 
                                       name="{{ field.name }}" 
                                       id="{{ field.name }}"
                                       {% if field.required %}required{% endif %}
                                       {% if field.get('pattern') %}pattern="{{ field.pattern }}"{% endif %}
                                       {% if field.default is not none %}value="{{ field.default }}"{% endif %}
                                       placeholder="#000000"
                                       data-color-input>
                                <input type="color" 
                                       class="color-picker-hidden"
                                       data-color-picker="{{ field.name }}"
                                       {% if field.default is not none %}value="{{ field.default }}"{% endif %}>
                                <div class="color-preview" 
                                     data-color-preview="{{ field.name }}"
                                     style="background-color: {{ field.default or '#000000' }}"
                                     title="Click to pick color"></div>
                            </div>
                            <div class="field-error" id="error-{{ field.name }}"></div>
                        </div>
                    {% elif field.type == 'file' %}
                        <div class="field">
                            <label for="{{ field.name }}">{{ field.name }}</label>
                            <input type="file" 
                                   name="{{ field.name }}" 
                                   id="{{ field.name }}"
                                   {% if field.required %}required{% endif %}
                                   {% if field.get('accept') %}accept="{{ field.accept }}"{% endif %}
                                   class="file-input">
                            <div class="field-error" id="error-{{ field.name }}"></div>
                        </div>
                    {% else %}
                        <div class="field">
                            <label for="{{ field.name }}">{{ field.name }}</label>
                            <input type="{{ field.type }}" 
                                   name="{{ field.name }}" 
                                   id="{{ field.name }}"
                                   {% if field.required %}required{% endif %}
                                   {% if field.get('min') is not none %}min="{{ field.min }}"{% endif %}
                                   {% if field.get('max') is not none %}max="{{ field.max }}"{% endif %}
                                   {% if field.get('step') %}step="{{ field.step }}"{% endif %}
                                   {% if field.get('minlength') %}minlength="{{ field.minlength }}"{% endif %}
                                   {% if field.get('maxlength') %}maxlength="{{ field.maxlength }}"{% endif %}
                                   {% if field.get('pattern') %}pattern="{{ field.pattern }}"{% endif %}
                                   {% if field.default is not none %}value="{{ field.default }}"{% endif %}>
                            <div class="field-error" id="error-{{ field.name }}"></div>
                        </div>
                    {% endif %}
                {% endfor %}
                <button type="submit">Submit</button>
            </form>
            
            <div id="result"></div>
            <div id="error"></div>
        </div>
    </div> <script>
        const form = document.getElementById('form');
        const resultDiv = document.getElementById('result');
        const errorDiv = document.getElementById('error');
        
        document.querySelectorAll('[data-color-input]').forEach(input => {
            const preview = document.querySelector(`[data-color-preview="${input.name}"]`);
            const picker = document.querySelector(`[data-color-picker="${input.name}"]`);
            
            input.addEventListener('input', (e) => {
                const value = e.target.value;
                if (/^#[0-9a-fA-F]{6}$/.test(value) || /^#[0-9a-fA-F]{3}$/.test(value)) {
                    preview.style.backgroundColor = value;
                    picker.value = value.length === 4 ? '#' + value[1] + value[1] + value[2] + value[2] + value[3] + value[3] : value;
                }
            });
            
            preview.addEventListener('click', () => {
                picker.click();
            });
            
            picker.addEventListener('input', (e) => {
                input.value = e.target.value;
                preview.style.backgroundColor = e.target.value;
                if (input.classList.contains('was-validated')) {
                    validateField(input);
                }
            });
        });
        
        form.querySelectorAll('input, select').forEach(input => {
            input.addEventListener('blur', () => validateField(input));
            input.addEventListener('input', () => {
                if (input.classList.contains('was-validated')) {
                    validateField(input);
                }
            });
        });
        
        function validateField(input) {
            const errorEl = document.getElementById(`error-${input.name}`);
            if (!errorEl) return true;
            
            input.classList.add('was-validated');
            
            if (!input.validity.valid) {
                if (input.validity.valueMissing) {
                    errorEl.textContent = 'This field is required';
                } else if (input.validity.rangeUnderflow) {
                    errorEl.textContent = `Minimum value is ${input.min}`;
                } else if (input.validity.rangeOverflow) {
                    errorEl.textContent = `Maximum value is ${input.max}`;
                } else if (input.validity.tooShort) {
                    errorEl.textContent = `Minimum length is ${input.minLength} characters`;
                } else if (input.validity.tooLong) {
                    errorEl.textContent = `Maximum length is ${input.maxLength} characters`;
                } else if (input.validity.stepMismatch) {
                    errorEl.textContent = `Value must be a valid number`;
                } else if (input.validity.typeMismatch) {
                    if (input.type === 'email') {
                        errorEl.textContent = 'Please enter a valid email';
                    } else if (input.type === 'url') {
                        errorEl.textContent = 'Please enter a valid URL';
                    } else {
                        errorEl.textContent = 'Invalid format';
                    }
                } else if (input.validity.patternMismatch) {
                    if (input.dataset.colorInput !== undefined) {
                        errorEl.textContent = 'Please enter a valid color (#RGB or #RRGGBB)';
                    } else if (input.type === 'file') {
                        errorEl.textContent = 'Please select a valid file type';
                    } else {
                        errorEl.textContent = 'Invalid format';
                    }
                } else {
                    errorEl.textContent = 'Invalid value';
                }
                errorEl.style.display = 'block';
                return false;
            } else {
                errorEl.style.display = 'none';
                return true;
            }
        }
        
        form.addEventListener('submit', async (e) => {
            e.preventDefault();
            
            let isValid = true;
            form.querySelectorAll('input:not([type="checkbox"]):not(.color-picker-hidden), select').forEach(input => {
                if (!validateField(input)) {
                    isValid = false;
                }
            });
            
            if (!isValid) {
                errorDiv.textContent = 'Please fix the errors above';
                errorDiv.style.display = 'block';
                resultDiv.style.display = 'none';
                return;
            }
            
            resultDiv.style.display = 'none';
            errorDiv.style.display = 'none';
            
            try {
                const response = await fetch('{{ submit_url }}', {
                    method: 'POST',
                    body: new FormData(form)
                });
                
                const data = await response.json();
                
                if (data.success) {
                    if (data.result_type === 'image') {
                        resultDiv.innerHTML = '<img src="' + data.result + '" alt="Result">';
                    } else {
                        resultDiv.innerHTML = '<pre>' + JSON.stringify(data.result, null, 2) + '</pre>';
                    }
                    resultDiv.style.display = 'block';
                } else {
                    errorDiv.textContent = 'Error: ' + data.error;
                    errorDiv.style.display = 'block';
                }
            } catch (err) {
                errorDiv.textContent = 'Error: ' + err.message;
                errorDiv.style.display = 'block';
            }
        });
    </script>
</body>
</html>