#!/bin/bash

# –°–∫—Ä–∏–ø—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è –∞–Ω–Ω–æ—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö git —Ç–µ–≥–æ–≤ –∏ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∏—Ö –Ω–∞ GitHub
# –ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ: ./create_tag.sh <–Ω–∞–∑–≤–∞–Ω–∏–µ_—Ç–µ–≥–∞> <–æ–ø–∏—Å–∞–Ω–∏–µ>
# –ü—Ä–∏–º–µ—Ä: ./create_tag.sh v1.2.0 "–î–æ–±–∞–≤–ª–µ–Ω–∞ –∞–¥–º–∏–Ω—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞"

set -e  # –ü—Ä–µ—Ä—ã–≤–∞—Ç—å –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ –ø—Ä–∏ –æ—à–∏–±–∫–µ

# –¶–≤–µ—Ç–∞ –¥–ª—è –≤—ã–≤–æ–¥–∞
GREEN='\033[0;32m'
RED='\033[0;31m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m' # No Color

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —Ü–≤–µ—Ç–Ω–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
print_color() {
    local color=$1
    local message=$2
    echo -e "${color}${message}${NC}"
}

# –§—É–Ω–∫—Ü–∏—è –¥–ª—è –≤—ã–≤–æ–¥–∞ —Å–ø—Ä–∞–≤–∫–∏
show_help() {
    echo "üè∑Ô∏è  –°–∫—Ä–∏–ø—Ç —Å–æ–∑–¥–∞–Ω–∏—è git —Ç–µ–≥–æ–≤"
    echo ""
    echo "–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏–µ:"
    echo "  ./create_tag.sh <–Ω–∞–∑–≤–∞–Ω–∏–µ_—Ç–µ–≥–∞> <–æ–ø–∏—Å–∞–Ω–∏–µ>"
    echo ""
    echo "–ü—Ä–∏–º–µ—Ä—ã:"
    echo "  ./create_tag.sh v1.0.0 '–ü–µ—Ä–≤—ã–π —Ä–µ–ª–∏–∑'"
    echo "  ./create_tag.sh v1.2.0 '–î–æ–±–∞–≤–ª–µ–Ω–∞ –∞–¥–º–∏–Ω—Å–∫–∞—è —Å–∏—Å—Ç–µ–º–∞'"
    echo "  ./create_tag.sh hotfix-1.1.1 '–ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∞ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∞—è –æ—à–∏–±–∫–∞'"
    echo ""
    echo "–ü–∞—Ä–∞–º–µ—Ç—Ä—ã:"
    echo "  –Ω–∞–∑–≤–∞–Ω–∏–µ_—Ç–µ–≥–∞  - –ò–º—è —Ç–µ–≥–∞ (–Ω–∞–ø—Ä–∏–º–µ—Ä: v1.0.0, release-2024-01)"
    echo "  –æ–ø–∏—Å–∞–Ω–∏–µ       - –û–ø–∏—Å–∞–Ω–∏–µ –∏–∑–º–µ–Ω–µ–Ω–∏–π –≤ –∫–∞–≤—ã—á–∫–∞—Ö"
    echo ""
    echo "–û–ø—Ü–∏–∏:"
    echo "  -h, --help     - –ü–æ–∫–∞–∑–∞—Ç—å —ç—Ç—É —Å–ø—Ä–∞–≤–∫—É"
}

# –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–æ–≤ –∫–æ–º–∞–Ω–¥–Ω–æ–π —Å—Ç—Ä–æ–∫–∏
if [[ "$1" == "-h" || "$1" == "--help" ]]; then
    show_help
    exit 0
fi

if [[ $# -ne 2 ]]; then
    print_color $RED "‚ùå –û—à–∏–±–∫–∞: –¢—Ä–µ–±—É–µ—Ç—Å—è 2 –ø–∞—Ä–∞–º–µ—Ç—Ä–∞"
    echo ""
    show_help
    exit 1
fi

TAG_NAME="$1"
TAG_DESCRIPTION="$2"

print_color $BLUE "üè∑Ô∏è  –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–≥–∞ –¥–ª—è –ø—Ä–æ–µ–∫—Ç–∞"
print_color $BLUE "================================"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ –º—ã –≤ git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–∏
if ! git rev-parse --git-dir > /dev/null 2>&1; then
    print_color $RED "‚ùå –û—à–∏–±–∫–∞: –¢–µ–∫—É—â–∞—è –¥–∏—Ä–µ–∫—Ç–æ—Ä–∏—è –Ω–µ —è–≤–ª—è–µ—Ç—Å—è git —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä–∏–µ–º"
    exit 1
fi

# –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Ç–µ–≥ –Ω–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç
if git rev-parse "$TAG_NAME" >/dev/null 2>&1; then
    print_color $RED "‚ùå –û—à–∏–±–∫–∞: –¢–µ–≥ '$TAG_NAME' —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç"
    echo "–°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —Ç–µ–≥–∏:"
    git tag -l | grep -E "^$TAG_NAME" || echo "–ù–µ—Ç –ø–æ—Ö–æ–∂–∏—Ö —Ç–µ–≥–æ–≤"
    exit 1
fi

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ç–µ–∫—É—â–µ–º —Å–æ—Å—Ç–æ—è–Ω–∏–∏
print_color $YELLOW "üìã –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –ø—Ä–æ–µ–∫—Ç–µ:"
echo "   –î–∏—Ä–µ–∫—Ç–æ—Ä–∏—è: $(pwd)"
echo "   –¢–µ–∫—É—â–∞—è –≤–µ—Ç–∫–∞: $(git branch --show-current)"
echo "   –ü–æ—Å–ª–µ–¥–Ω–∏–π –∫–æ–º–º–∏—Ç: $(git log -1 --oneline)"
echo "   –°—Ç–∞—Ç—É—Å: $(git status --porcelain | wc -l) –∏–∑–º–µ–Ω–µ–Ω–Ω—ã—Ö —Ñ–∞–π–ª–æ–≤"

# –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –Ω–µ–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è
if [[ -n $(git status --porcelain) ]]; then
    print_color $YELLOW "‚ö†Ô∏è  –í–Ω–∏–º–∞–Ω–∏–µ: –ï—Å—Ç—å –Ω–µ–ø–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–Ω—ã–µ –∏–∑–º–µ–Ω–µ–Ω–∏—è"
    git status --short
    echo ""
    read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–≥–∞? (y/N): " -n 1 -r
    echo ""
    if [[ ! $REPLY =~ ^[Yy]$ ]]; then
        print_color $YELLOW "–°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–≥–∞ –æ—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º"
        exit 0
    fi
fi

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —á—Ç–æ –±—É–¥–µ–º –¥–µ–ª–∞—Ç—å
print_color $BLUE "üéØ –ü–ª–∞–Ω–∏—Ä—É–µ–º—ã–µ –¥–µ–π—Å—Ç–≤–∏—è:"
echo "   1. –°–æ–∑–¥–∞—Ç—å –∞–Ω–Ω–æ—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–≥ '$TAG_NAME'"
echo "   2. –î–æ–±–∞–≤–∏—Ç—å –æ–ø–∏—Å–∞–Ω–∏–µ: '$TAG_DESCRIPTION'"
echo "   3. –û—Ç–ø—Ä–∞–≤–∏—Ç—å —Ç–µ–≥ –Ω–∞ GitHub"
echo ""

# –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ
read -p "–ü—Ä–æ–¥–æ–ª–∂–∏—Ç—å? (Y/n): " -n 1 -r
echo ""
if [[ $REPLY =~ ^[Nn]$ ]]; then
    print_color $YELLOW "–°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–≥–∞ –æ—Ç–º–µ–Ω–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º"
    exit 0
fi

print_color $BLUE "üöÄ –°–æ–∑–¥–∞–Ω–∏–µ —Ç–µ–≥–∞..."

# –°–æ–∑–¥–∞–µ–º –∞–Ω–Ω–æ—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π —Ç–µ–≥
print_color $GREEN "üìù –°–æ–∑–¥–∞–Ω–∏–µ –∞–Ω–Ω–æ—Ç–∏—Ä–æ–≤–∞–Ω–Ω–æ–≥–æ —Ç–µ–≥–∞ '$TAG_NAME'..."
if git tag -a "$TAG_NAME" -m "$TAG_DESCRIPTION"; then
    print_color $GREEN "‚úÖ –¢–µ–≥ '$TAG_NAME' —É—Å–ø–µ—à–Ω–æ —Å–æ–∑–¥–∞–Ω"
else
    print_color $RED "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ —Å–æ–∑–¥–∞–Ω–∏–∏ —Ç–µ–≥–∞"
    exit 1
fi

# –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ç–µ–≥ –Ω–∞ GitHub
print_color $GREEN "üì§ –û—Ç–ø—Ä–∞–≤–∫–∞ —Ç–µ–≥–∞ –Ω–∞ GitHub..."
if git push origin "$TAG_NAME"; then
    print_color $GREEN "‚úÖ –¢–µ–≥ —É—Å–ø–µ—à–Ω–æ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ GitHub"
else
    print_color $RED "‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ç–µ–≥–∞ –Ω–∞ GitHub"
    print_color $YELLOW "üí° –¢–µ–≥ —Å–æ–∑–¥–∞–Ω –ª–æ–∫–∞–ª—å–Ω–æ, –Ω–æ –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ GitHub"
    print_color $YELLOW "    –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –≤—Ä—É—á–Ω—É—é: git push origin $TAG_NAME"
    exit 1
fi

# –ü–æ–∫–∞–∑—ã–≤–∞–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Å–æ–∑–¥–∞–Ω–Ω–æ–º —Ç–µ–≥–µ
print_color $BLUE "üìä –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Å–æ–∑–¥–∞–Ω–Ω–æ–º —Ç–µ–≥–µ:"
git show "$TAG_NAME" --no-patch --format="   –¢–µ–≥: %D%n   –ê–≤—Ç–æ—Ä: %an <%ae>%n   –î–∞—Ç–∞: %ad%n   –°–æ–æ–±—â–µ–Ω–∏–µ: %s%n   –û–ø–∏—Å–∞–Ω–∏–µ: %(trailers)"

print_color $GREEN "üéâ –ì–æ—Ç–æ–≤–æ!"
print_color $GREEN "‚úÖ –¢–µ–≥ '$TAG_NAME' —Å–æ–∑–¥–∞–Ω –∏ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω –Ω–∞ GitHub"
echo ""
print_color $BLUE "üîó –ü–æ–ª–µ–∑–Ω—ã–µ –∫–æ–º–∞–Ω–¥—ã:"
echo "   –ü—Ä–æ—Å–º–æ—Ç—Ä –≤—Å–µ—Ö —Ç–µ–≥–æ–≤: git tag -l"
echo "   –ü—Ä–æ—Å–º–æ—Ç—Ä —Ç–µ–≥–∞: git show $TAG_NAME"
echo "   –£–¥–∞–ª–µ–Ω–∏–µ —Ç–µ–≥–∞ (–µ—Å–ª–∏ –Ω—É–∂–Ω–æ): git tag -d $TAG_NAME && git push origin :refs/tags/$TAG_NAME"