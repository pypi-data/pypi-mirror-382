{% extends "index.html" %}
{% load static reports_tags horilla_tags %}
{% load i18n %}
{% block content %}

<div class="flex modelcontent">
    {% include "components/sub_sidebar.html" %}
    <div id="mainContent" class="flex-[1_0] leftspace transition-all duration-300 ease-in-out pt-0">
        <button hidden id="reloadButton" hx-get="{% url 'reports:report_detail' report.pk %}?{{request.GET.urlencode}}" hx-target="#report-content" hx-trigger="click" hx-swap="outerHTML" hx-select="#report-content">click</button>
        <div class="bg-white px-5 border-b border-b-dark-50 fixed w-[-webkit-fill-available] z-20">
            <div class="flex items-center gap-2 justify-between"> 
                <div class="flex items-start">
                    <button onclick="window.history.back()">
                        <i class="fas fa-arrow-left mr-2"></i>
                    </button>
                    <div>
                        <h3 class="text-md font-semibold">{{ report.name }}</h3>
                        <p class="text-xs">{% trans "Report:" %} {{ report.module_verbose_name }}</p>
                    </div>
                </div>
                <div id="nav-actions"  class="flex items-center gap-5 h-[70px]"> 
                    <div class="flex items-center">
                        <button onclick="$('#reloadButton').click();"
                        ><img src="{% static 'assets/icons/l5.svg' %}" alt="" width="17" /></button>
                    </div>
                    {% if panel_open %}
                        {% if has_unsaved_changes %}
                            <div class="flex items-center">
                                <button id="saveBtn" 
                                        title="Save"
                                        hx-post="{% url 'reports:save_report_changes' report.pk %}" 
                                        hx-trigger="click"
                                        hx-target="#mainContent"
                                        hx-swap="outerHTML"
                                        hx-select="#mainContent"
                                        >
                                        <img src="{% static 'assets/icons/save.svg' %}" alt="" width="16" />
                                </button>
                            </div>
                            <div class="flex items-center">
                                <button id="discardBtn" 
                                        title="Discard Changes"
                                        hx-post="{% url 'reports:discard_report_changes' report.pk %}" 
                                        hx-trigger="click"
                                        hx-target="#mainContent"
                                        hx-swap="outerHTML"
                                        hx-select="#mainContent"
                                        >
                                        <img src="{% static 'assets/icons/close.svg' %}" alt="" width="16" />
                                </button>
                            </div>
                        {% else %}
                            <div class="flex items-center">
                                <button id="closeBtn" 
                                        title="Close Panel"
                                        hx-get="{% url 'reports:report_detail' report.pk %}" 
                                        hx-target="#mainContent"
                                        hx-swap="outerHTML"
                                        hx-select="#mainContent">
                                        <img src="{% static 'assets/icons/close.svg' %}" alt="" width="16" />
                                </button>
                            </div>
                        {% endif %}
                    {% else %}
                        <!-- Edit button when panel is closed -->
                        <div class="flex items-center">
                            <button id="toggleBtn" 
                                    title="Edit Report"
                                    hx-get="{% url 'reports:report_update' report.pk %}" 
                                    hx-target="#panel"
                                    hx-swap="outerHTML"
                                    hx-headers='{"HX-Trigger": "togglePanel"}'>
                                <img src="{% static 'assets/icons/pen.svg' %}" alt="" width="16" />
                            </button>
                        </div>
                    {% endif %}
                    <div class="flex items-center relative">
                        <button id="exportDropdownButton" 
                                data-dropdown-toggle="exportDropdown" 
                                type="button" 
                                class="flex items-center">
                            {% comment %} <i class="fas fa-file-export mr-2"></i> {% endcomment %}
                            <img src="{% static 'assets/icons/down.svg' %}" alt="" width="15" class="ml-1" />
                        </button>
                        <!-- Dropdown menu -->
                        <div id="exportDropdown" 
                             class="z-10 hidden bg-white rounded-lg shadow-lg min-w-[160px] absolute top-8 right-0">
                            <ul class="text-sm" aria-labelledby="exportDropdownButton">
                                <li>
                                    <a href="{% url 'reports:report_export' report.pk %}?format=excel" 
                                       class="block px-4 py-2 hover:bg-gray-100 flex items-center">
                                        <i class="fas fa-file-excel text-green-600 mr-2"></i>
                                        Excel (.xlsx)
                                    </a>
                                </li>
                                <li>
                                    <a href="{% url 'reports:report_export' report.pk %}?format=csv" 
                                       class="block px-4 py-2 hover:bg-gray-100 flex items-center">
                                        <i class="fas fa-file-csv text-blue-600 mr-2"></i>
                                        CSV (.csv)
                                    </a>
                                </li>
                                <li>
                                    <a href="{% url 'reports:report_export' report.pk %}?format=pdf" 
                                       class="block px-4 py-2 hover:bg-gray-100 flex items-center">
                                        <i class="fas fa-file-pdf text-red-600 mr-2"></i>
                                        PDF (.pdf)
                                    </a>
                                </li>
                            </ul>
                        </div> 
                    </div>
                </div>
            </div>
        </div>
        <div class="flex p-5 pt-24" id="report-content">
            <div class="sec1" style="flex: 1 0">
                {% if has_unsaved_changes %}
                    <div class="bg-primary-100 border border-primary-500 rounded-lg p-3 mb-4">
                        <div class="flex items-center">
                            <div class="flex-shrink-0">
                                <svg class="h-5 w-5 text-primary-600" viewBox="0 0 20 20" fill="currentColor">
                                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                                </svg>
                            </div>
                            <div class="ml-3">
                                <p class="text-sm text-primary-600">
                                   {% trans 'You have unsaved changes. Click'%} <strong>{% trans 'Save' %}</strong> {% trans 'to keep your changes or' %} <strong>{% trans 'Discard' %}</strong> {% trans 'to revert.' %}
                                </p>
                            </div>
                        </div>
                    </div>
                {% endif %}
                <div class="flex justify-between items-center mb-3">
                    <ul class="flex gap-3 text-sm items-center">
                        <li>
                            <a href="" class="bg-[#25c32417] border border-[solid] border-[#25c32429] text-[#21b320] font-medium text-xs px-3 py-1.5 flex items-center justify-center rounded-md">
                                {% trans 'Total Count' %} - {{ total_count }}
                            </a>
                        </li> 
                    </ul>
                </div>
                <div class="grid grid-cols-12 gap-4 mb-4">
                    <div class="col-span-12 ">
                        <div class="[box-shadow:0px_0px_20px_0px_rgb(0_0_0_/_5%)] bg-white rounded-lg p-3 h-full">
                            <h3 class="text-sm font-semibold mb-3">{% trans 'Detail table' %}</h3>
                            <div id="details-table"> {% include 'list_view.html' %}</div>
                        </div>
                    </div>
                    <div class="col-span-12">
                        <div class="h-full overflow-x-auto custom-scroll [box-shadow:0px_0px_20px_0px_rgb(0_0_0_/_5%)] bg-white rounded-lg z-0 p-4" id="pivot-table">
                            <h3 class="text-sm font-semibold mb-3">{% trans 'Pivot table' %}</h3>
                            {% include 'partials/pivot_table.html' %}
                        </div>
                    </div>
                    <div class="col-span-12">
                        <div class="[box-shadow:0px_0px_20px_0px_rgb(0_0_0_/_5%)] bg-white rounded-lg p-3 h-full" id="chart-container">
                            <div class="flex justify-between">
                                <h3 class="text-sm font-semibold mb-3"> {% trans 'Report Chart' %} </h3>
                                <div class="relative">
                                    <button id="dropdownLeftEndButton" data-dropdown-toggle="dropdownLeftEnd12" data-dropdown-placement="left" type="button" class="flex">
                                        <img src="{% static 'assets/icons/down.svg' %}" alt="" width="15" />
                                    </button>
                                    <div id="dropdownLeftEnd12" class="z-10 hidden bg-white rounded-lg [box-shadow:0px_0px_20px_0px_rgb(0_0_0_/_5%)] min-w-[160px] top-8 -right-[15px]">
                                        <ul class="text-sm z-50 relative" aria-labelledby="dropdownLeftEndButton">
                                            <li><a href="#" class="block px-3 py-1.5 hover:text-primary-600 transition duration-300 text-[.8rem]" 
                                                  hx-get="{% url 'reports:change_chart_type' report.pk %}" 
                                                  hx-on:click="openModal();"
                                                  hx-target="#modalBox"
                                                  hx-swap="innerHTML"
                                                  >{% trans 'Change Chart' %}</a></li>
                                                  <li><a href="#" class="block px-3 py-1.5 hover:text-primary-600 transition duration-300 text-[.8rem]" 
                                                    hx-get="{% url 'reports:change_chart_field' report.pk %}" 
                                                    hx-on:click="openModal();"
                                                    hx-target="#modalBox"
                                                    hx-swap="innerHTML"
                                                    >{% trans 'Change Field' %}</a></li>
                                                <li><a href="#" class="block px-3 py-1.5 hover:text-primary-600 transition duration-300 text-[.8rem]" 
                                                        onclick="exportChartAsPDF('chart-{{ report.pk }}', 'report_{{ report.pk }}')">Export as PDF</a></li>
                                                  <li><a href="#" class="block px-3 py-1.5 hover:text-primary-600 transition duration-300 text-[.8rem]" 
                                                        onclick="EChartsConfig.exportChart(window.reportChartInstance_{{ report.pk }}, 'report_{{ report.pk }}', 'png')">Export as PNG</a></li>
                                            <li><a href="#" class="block px-3 py-1.5 hover:text-primary-600 transition duration-300 text-[.8rem]">Add to Dashboard</a></li>
                                        </ul>
                                    </div>
                                </div>
                            </div>
                            <p class="text-xs mb-2">{% trans 'Record Count:' %} {{ total_count }}</p>
                            {% if chart_data.error %}
                                <p class="text-red-500">{{ chart_data.error }}</p>
                            {% else %}
                            <div class="flex justify-between items-center">
                                <div id="chart-{{ report.pk }}" style="width: 100%; height: 250px; max-width:800px;"></div>
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            <div id="panel" 
                 class="transition-all duration-300 overflow-hidden overflow-x-auto {% if panel_open %}w-80{% else %}w-0{% endif %} bg-white [box-shadow:0px_0px_20px_0px_rgb(0_0_0_/_5%)] rounded-lg h-[calc(100vh_-_220px)] ms-4"
                 {% if panel_open %}hx-get="{% url 'reports:report_update' report.pk %}" hx-trigger="load" hx-swap="outerHTML"{% endif %}>
            </div>

            <script src="{% static 'assets/js/horilla_charts.js' %}"></script>
            <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
            <script>
                (function() {
                    let chartInstance = null;

                    // Function to export chart as PDF
                    window.exportChartAsPDF = function(chartId, filename) {
                        try {
                            // Check if jsPDF is loaded
                            if (!window.jspdf || !window.jspdf.jsPDF) {
                                console.error('jsPDF library is not loaded. Please ensure the jsPDF script is included.');
                                alert('Failed to export PDF: jsPDF library is not loaded.');
                                return;
                            }

                            const chartInstance = window[`reportChartInstance_${chartId.split('-')[1]}`];
                            if (!chartInstance) {
                                console.error('Chart instance not found for ID:', chartId);
                                alert('Failed to export PDF: Chart instance not found.');
                                return;
                            }

                            // Ensure chart is rendered
                            chartInstance.resize();
                            
                            const imgData = chartInstance.getDataURL({
                                pixelRatio: 2,
                                backgroundColor: '#fff',
                                excludeComponents: ['toolbox']
                            });

                            if (!imgData) {
                                console.error('Failed to generate chart image data.');
                                alert('Failed to export PDF: Could not generate chart image.');
                                return;
                            }

                            const { jsPDF } = window.jspdf;
                            const pdf = new jsPDF({
                                orientation: 'landscape',
                                unit: 'px',
                                format: [800, 400]
                            });

                            const imgProps = pdf.getImageProperties(imgData);
                            const pdfWidth = pdf.internal.pageSize.getWidth();
                            const pdfHeight = pdf.internal.pageSize.getHeight();
                            const imgWidth = 700;
                            const imgHeight = (imgProps.height * imgWidth) / imgProps.width;

                            const x = (pdfWidth - imgWidth) / 2;
                            const y = (pdfHeight - imgHeight) / 2;

                            pdf.addImage(imgData, 'PNG', x, y, imgWidth, imgHeight);
                            pdf.save(`${filename}.pdf`);
                        } catch (error) {
                            console.error('Error exporting chart as PDF:', error);
                            alert('Failed to export PDF: An error occurred. Please check the console for details.');
                        }
                    };

                    function initChart() {
                        {% if not chart_data.error %}
                            const chartContainer = document.getElementById('chart-{{ report.pk }}');
                            if (!chartContainer) {
                                console.error('Chart container not found for ID: chart-{{ report.pk }}');
                                return;
                            }

                            // Dispose existing chart instance if it exists
                            if (window.reportChartInstance_{{ report.pk }}) {
                                window.reportChartInstance_{{ report.pk }}.dispose();
                                window.reportChartInstance_{{ report.pk }} = null;
                            }

                            // Initialize ECharts instance with fresh data
                            chartInstance = echarts.init(chartContainer);
                            window.reportChartInstance_{{ report.pk }} = chartInstance;

                            const chartConfig = {
                                type: '{{ chart_data.type|lower|safe|default:"pie" }}',
                                labels: {{ chart_data.labels|safe|default:"[]" }},
                                data: {{ chart_data.data|safe|default:"[]" }},
                                colors: EChartsConfig.getDynamicColors({{ chart_data.labels|length|default:0 }}),
                                labelField: '{{ chart_data.label_field|title|safe|default:"Count" }}',
                                stackedData: {{ chart_data.stacked_data|safe|default:"{}" }},
                                hasMultipleGroups: {{ chart_data.has_multiple_groups|yesno:"true,false" }}
                            };

                            const option = EChartsConfig.getChartOption(chartConfig);
                            chartInstance.setOption(option, true);

                            // Force resize to adapt to container dimensions
                            setTimeout(() => {
                                if (chartInstance && !chartInstance.isDisposed()) {
                                    chartInstance.resize();
                                }
                            }, 100);

                            // Handle window resize
                            const resizeHandler = function() {
                                if (chartInstance && !chartInstance.isDisposed()) {
                                    chartInstance.resize();
                                }
                            };
                            window.addEventListener('resize', resizeHandler);
                        {% endif %}
                    }

                    // Initialize chart immediately when script loads
                    if (typeof echarts !== 'undefined' && typeof EChartsConfig !== 'undefined') {
                        initChart();
                    } else {
                        console.warn('ECharts or EChartsConfig not loaded. Retrying chart initialization...');
                        setTimeout(initChart, 100);
                    }

                    // Reinitialize chart after HTMX updates
                    document.body.addEventListener('htmx:afterSettle', function(event) {
                        if (event.target.id === 'report-content' || event.target.id === 'mainContent') {
                            setTimeout(function() {
                                initChart();
                            }, 100);
                        }
                    });

                    // Handle refreshReport trigger
                    document.body.addEventListener('htmx:afterRequest', function(event) {
                        if (event.detail.requestConfig.headers['HX-Trigger'] === 'refreshReport') {
                            htmx.ajax('GET', '{% url "reports:report_update" report.pk %}', {
                                target: '#panel',
                                swap: 'outerHTML'
                            });
                        }
                    });
                })();

                document.addEventListener('DOMContentLoaded', function() {
                    const dropdownButton = document.getElementById('exportDropdownButton');
                    const dropdownMenu = document.getElementById('exportDropdown');
                    
                    if (dropdownButton && dropdownMenu) {
                        dropdownButton.addEventListener('click', function(e) {
                            e.preventDefault();
                            dropdownMenu.classList.toggle('hidden');
                        });
                        
                        // Close dropdown when clicking outside
                        document.addEventListener('click', function(e) {
                            if (!dropdownButton.contains(e.target) && !dropdownMenu.contains(e.target)) {
                                dropdownMenu.classList.add('hidden');
                            }
                        });
                    }
                });
            </script>
        </div>   
    </div>
</div>
{% endblock %}