"""Jupyter stuffs"""
import gc
import sys
import traceback
from typing import TYPE_CHECKING

import torch

if TYPE_CHECKING:
    def get_ipython(): pass

def clean_ipython_hist():
    """    Clean up IPython history by removing input history and variables.

    This function cleans up the IPython history by removing input history
    and variables stored in the user namespace.  Source: ... (idk but I
    found it from fastai)
    """
    # Code in this function mainly copied from IPython source
    if  'get_ipython' not in globals(): return
    ip = get_ipython() # type: ignore #pylint:disable=E1111
    user_ns = ip.user_ns # type:ignore
    ip.displayhook.flush()# type:ignore
    pc = ip.displayhook.prompt_count + 1# type:ignore
    for n in range(1, pc): user_ns.pop('_i'+repr(n),None)
    user_ns.update(dict(_i='',_ii='',_iii=''))
    hm = ip.history_manager# type:ignore
    hm.input_hist_parsed[:] = [''] * pc
    hm.input_hist_raw[:] = [''] * pc
    hm._i = hm._ii = hm._iii = hm._i00 =  ''#pylint:disable=W0212

def clean_tb():
    """Clean up the traceback information stored in the sys module.

    This function clears the frames from the last traceback and removes the
    last_type, last_value, and last_traceback attributes from the sys module
    if they exist.

    Note:
        This function is based on the implementation by Piotr Czapla.

    Note2:
        The first note was generated by AI but it might still be true.
    """

    # h/t Piotr Czapla
    if hasattr(sys, 'last_traceback'):
        traceback.clear_frames(sys.last_traceback) # pylint:disable=deprecated-attribute
        delattr(sys, 'last_traceback')
    if hasattr(sys, 'last_type'): delattr(sys, 'last_type')
    if hasattr(sys, 'last_value'): delattr(sys, 'last_value')

def clean_mem():
    """Clean memory by clearing traceback, IPython history, and garbage
    collection.

    This function cleans the traceback, IPython history, and performs
    garbage collection twice. It also empties the CUDA memory cache if
    PyTorch is being used.
    """

    clean_tb()
    clean_ipython_hist()
    gc.collect()
    gc.collect()
    torch.cuda.empty_cache()

