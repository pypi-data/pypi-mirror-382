---
name: Integration tests on Fabric DW
on:
  workflow_dispatch:
  schedule:
    - cron: '0 1 * * 0'
  pull_request:
    branches:
      - forked-version
  push:
    branches:
      - forked-version

permissions:
  contents: read
  packages: read
  id-token: write

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  integration-tests-fabric-dw:
    name: Integration tests on Fabric DW
    strategy:
      fail-fast: false
      matrix:
        include:
          - msodbc_version: "17"
            python_version: "3.13"
            dwh_name: "ci01"
          - msodbc_version: "18"
            python_version: "3.10"
            dwh_name: "ci02"
          - msodbc_version: "18"
            python_version: "3.11"
            dwh_name: "ci03"
          - msodbc_version: "18"
            python_version: "3.12"
            dwh_name: "ci04"
          - msodbc_version: "18"
            python_version: "3.13"
            dwh_name: "ci05"

    runs-on: ubuntu-latest
    environment: azure
    container: 
      image: ghcr.io/${{ github.repository }}:CI-${{ matrix.python_version }}-msodbc${{ matrix.msodbc_version }}
    steps:
      - name: Azure CLI Login
        uses: azure/login@v2
        with:
          client-id: ${{ secrets.AZURE_CLIENT_ID }}
          tenant-id: ${{ secrets.AZURE_TENANT_ID }}
          allow-no-subscriptions: true
      
      - uses: actions/checkout@v5

      - name: Install uv
        uses: astral-sh/setup-uv@v6
        with:
          python-version: ${{ matrix.python_version }}

      - name: Install dependencies
        run: uv sync

      - name: Run functional tests
        env:
          FABRIC_TEST_HOST: ${{ secrets.FABRIC_TEST_HOST }}
          FABRIC_TEST_DWH_NAME: ${{ matrix.dwh_name }}
          FABRIC_TEST_LAKEHOUSE_NAME: lh01
          FABRIC_TEST_DRIVER: "ODBC Driver ${{ matrix.msodbc_version }} for SQL Server"
        run: uv run pytest -ra -v
      
      - name: Upload test logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: logs-${{ matrix.msodbc_version }}-${{ matrix.python_version }}-${{ matrix.dwh_name }}
          path: logs/

  