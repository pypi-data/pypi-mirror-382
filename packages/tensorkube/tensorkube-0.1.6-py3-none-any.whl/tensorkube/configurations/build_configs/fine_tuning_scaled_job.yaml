apiVersion: keda.sh/v1alpha1
kind: ScaledJob
metadata:
  name: JOB_NAME
  namespace: keda
spec:
  jobTargetRef:
    backoffLimit: 0
    template:
      spec:
        serviceAccountName: keda-operator
        restartPolicy: Never
        backoffLimit: 0
        initContainers:
          - name: message-fetch-init
            image: richarvey/awscli:2.20.0
            command: ["COMMAND", "ARGS"]
            volumeMounts:
              - name: shared-data
                mountPath: /mnt/shared
            env:
              - name: AWS_REGION
                value: <REGION>
              - name: AWS_DEFAULT_REGION
                value: <REGION>
        containers:
          - name: sqs-job-1
            image: ${IMAGE_TAG}
            env:
              - name: AWS_REGION
                value: <REGION>
              - name: AWS_DEFAULT_REGION
                value: <REGION>
              - name: QUEUE_URL
                value: <QUEUE_URL>
            resources:
              requests:
                nvidia.com/gpu: ${GPUS}
              limits:
                nvidia.com/gpu: ${GPUS}
            volumeMounts:
              - mountPath: /dev/shm
                name: dshm
              - name: shared-data
                mountPath: /mnt/shared
          - name: sidecar
            image: tensorfuse/job-sidecar:v1
            command: ["COMMAND", "ARGS"]
            volumeMounts:
                - name: shared-data
                  mountPath: /mnt/shared
            env:
              - name: AWS_REGION
                value: <REGION>
              - name: AWS_DEFAULT_REGION
                value: <REGION>
        volumes:
          - name: dshm
            emptyDir:
              medium: Memory          
              sizeLimit: 10Gi 
          - name: shared-data
            emptyDir: {}
        affinity:
        nodeAffinity:
          requiredDuringSchedulingIgnoredDuringExecution:
            nodeSelectorTerms:
              - matchExpressions:
                  - key: karpenter.k8s.aws/instance-family
                    operator: NotIn
                    values:
                      - r5

  pollingInterval: 10        # Check the queue every 10 seconds
  maxReplicaCount: 2        # Max number of concurrent jobs
  successfulJobsHistoryLimit: 3   # Optional. Default: 100. How many completed jobs should be kept.
  failedJobsHistoryLimit: 2
  rollout:
    strategy: "gradual"
  scalingStrategy:
    strategy: "accurate"  # Scaling strategy to use
#    pendingPodConditons:
#      - PodScheduled
#      - PodReadyToStartContainers
#      - ContainersReady
#      - Initialized
#      - Ready
  triggers:
    - type: aws-sqs-queue
      metadata:
        queueURL: QUEUE_URL
        queueLength: "1"        # Scale up when there are 1 messages in the queue
        awsRegion: <REGION>
        scaleOnInFlight: "false"
      authenticationRef:
        name: aws-sqs-auth
